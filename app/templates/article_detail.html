<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ê¸°ì‚¬ ìƒì„¸ - TransNews</title>
    <link rel="stylesheet" href="/static/styles.css" />
    <script>
      let isLoading = false;

      function showLoading(message = "ì²˜ë¦¬ ì¤‘...") {
        if (isLoading) return;
        isLoading = true;

        const overlay = document.createElement("div");
        overlay.className = "loading-overlay";
        overlay.id = "loading-overlay";
        overlay.innerHTML = `
        <div class="loading-modal">
          <div class="spinner"></div>
          <h3>${message}</h3>
          <p>ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</p>
        </div>
      `;
        document.body.appendChild(overlay);
      }

      function hideLoading() {
        const overlay = document.getElementById("loading-overlay");
        if (overlay) {
          overlay.remove();
        }
        isLoading = false;
      }

      async function sendEmail() {
        const email = document.getElementById("email").value.trim();
        if (!email) {
          alert("ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          return;
        }

        if (!isValidEmail(email)) {
          alert("ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          return;
        }

        if (isLoading) return;

        showLoading("ì´ë©”ì¼ ì „ì†¡ ì¤‘...");

        try {
          const url = document.getElementById("detail-url").href;
          const title = document.getElementById("article-title").textContent;
          // const original = document.getElementById('detail-original').textContent;
          // const summary = document.getElementById('detail-summary').textContent;
          const original = (document.getElementById(
            "detail-original"
          ).textContent = isEn ? data.original_en || "" : data.original_ko);
          const summary = (document.getElementById(
            "detail-summary"
          ).textContent = isEn ? data.summary_en || "" : data.summary_ko);

          const response = await fetch("/api/email/send", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              email: email,
              title: title,
              url: url,
              original: original,
              summary: summary,
            }),
          });

          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || "ì´ë©”ì¼ ì „ì†¡ ì‹¤íŒ¨");
          }

          alert("ì´ë©”ì¼ì´ ì„±ê³µì ìœ¼ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
          document.getElementById("email").value = "";
        } catch (error) {
          alert("ì´ë©”ì¼ ì „ì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
        } finally {
          hideLoading();
        }
      }

      function isValidEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
      }

      // ë’¤ë¡œê°€ê¸° ë²„íŠ¼
      function goBack() {
        window.history.back();
      }
    </script>
  </head>
  <body>
    <div class="container">
      <!-- Header -->
      <header class="header">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
          "
        >
          <div>
            <h1>ê¸°ì‚¬ ìƒì„¸</h1>
          </div>
          <button
            onclick="goBack()"
            style="
              background: rgba(255, 255, 255, 0.2);
              border: 1px solid rgba(255, 255, 255, 0.3);
            "
          >
            â† ë’¤ë¡œê°€ê¸°
          </button>
        </div>
      </header>

      <!-- Language Toggle -->
      <section class="search-section">
        <div class="form-group">
          <label>í‘œì‹œ ì–¸ì–´</label>
          <div class="language-toggle">
            <label>
              <input type="radio" name="lang" value="ko" checked />
              <span>í•œêµ­ì–´</span>
            </label>
            <label>
              <input type="radio" name="lang" value="en" />
              <span>English</span>
            </label>
          </div>
        </div>
      </section>

      <!-- Email Form -->
      <section class="email-section">
        <div class="card">
          <h3>ğŸ“§ ì´ë©”ì¼ë¡œ ê¸°ì‚¬ ì „ì†¡</h3>
          <div
            style="
              display: flex;
              gap: 10px;
              align-items: center;
              flex-wrap: wrap;
            "
          >
            <input
              type="email"
              id="email"
              placeholder="ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”"
              style="
                flex: 1;
                min-width: 250px;
                padding: 10px;
                border: 1px solid #ddd;
                border-radius: 4px;
              "
            />
            <button
              onclick="sendEmail()"
              style="
                padding: 10px 20px;
                background: var(--primary);
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
              "
            >
              ì „ì†¡
            </button>
          </div>
        </div>
      </section>

      <!-- Article Detail Section -->
      <section id="article-detail" class="article-detail">
        <div class="article-header">
          <h2 id="article-title">ê¸°ì‚¬ ì œëª©</h2>
          <div>
            <strong>URL:</strong>
            <a id="detail-url" href="#" target="_blank" class="article-url"></a>
          </div>
        </div>

        <div class="content-section">
          <h3>ì›ë¬¸</h3>
          <div id="detail-original" class="content-text"></div>
        </div>

        <div class="content-section">
          <h3>ìš”ì•½</h3>
          <div id="detail-summary" class="content-text"></div>
        </div>
      </section>
    </div>

    <script>
      // URL íŒŒë¼ë¯¸í„°ì—ì„œ ê¸°ì‚¬ ì •ë³´ ë¡œë“œ
      async function loadArticle() {
        const urlParams = new URLSearchParams(window.location.search);
        const url = urlParams.get("url");
        const lang = urlParams.get("lang") || "ko";

        if (!url) {
          document.getElementById("article-detail").innerHTML =
            '<div class="text-center" style="padding: 40px; color: var(--muted);">ê¸°ì‚¬ URLì´ ì—†ìŠµë‹ˆë‹¤.</div>';
          return;
        }

        // ì–¸ì–´ ì„¤ì •
        document.querySelector(
          'input[name="lang"][value="' + lang + '"]'
        ).checked = true;

        showLoading("ê¸°ì‚¬ ë¶„ì„ ì¤‘...");

        try {
          const params = new URLSearchParams({ url, lang });
          const res = await fetch(`/api/article?${params.toString()}`);
          if (!res.ok) {
            throw new Error("ê¸°ì‚¬ ë¡œë”© ì‹¤íŒ¨");
          }

          const data = await res.json();
          displayArticle(data, lang);
        } catch (error) {
          alert("ê¸°ì‚¬ ë¡œë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
          document.getElementById("article-detail").innerHTML =
            '<div class="text-center" style="padding: 40px; color: var(--error);">ê¸°ì‚¬ ë¡œë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
        } finally {
          hideLoading();
        }
      }

      function displayArticle(data, lang) {
        const isEn = lang === "en";

        document.getElementById("article-title").textContent =
          data.title || "ì œëª© ì—†ìŒ";
        document.getElementById("detail-url").textContent = data.url;
        document.getElementById("detail-url").href = data.url;
        document.getElementById("detail-original").textContent = isEn
          ? data.original_en || ""
          : data.original_ko;
        document.getElementById("detail-summary").textContent = isEn
          ? data.summary_en || ""
          : data.summary_ko;
      }

      // ì–¸ì–´ ë³€ê²½ ì‹œ ë‹¤ì‹œ ë¡œë“œ
      document.querySelectorAll('input[name="lang"]').forEach((radio) => {
        radio.addEventListener("change", () => {
          const urlParams = new URLSearchParams(window.location.search);
          const url = urlParams.get("url");
          const lang = radio.value;

          const newParams = new URLSearchParams();
          newParams.append("url", url);
          newParams.append("lang", lang);

          window.location.href = `/article?${newParams.toString()}`;
        });
      });

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ê¸°ì‚¬ í‘œì‹œ
      loadArticle();
    </script>
  </body>
</html>
